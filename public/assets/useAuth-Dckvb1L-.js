import{u as h}from"./main-DAMVmj78.js";import{a as u}from"./auth-oaTOD9G4.js";import{h as i}from"./vendor-ynwioZzL.js";const _=()=>{const a=i(!1),o=i(null),t=h(),m=async s=>{a.value=!0,o.value=null;try{const r=await u.register(s);return r.access_token&&await k(r,s),r}catch(r){throw o.value=r.response?.data?.error||r.message,r}finally{a.value=!1}},g=async(s,r)=>{a.value=!0,o.value=null;try{const e=await u.login(s,r);let n,l;if(e.tokens&&e.user)l=e.tokens,n=e.user;else if(e.access_token)l={access_token:e.access_token,refresh_token:e.refresh_token},n=e.user;else throw new Error("Invalid response format from server");return t.login({id:n.id,username:n.username,email:n.email,token:l.access_token,role:n.role||"user"}),e}catch(e){throw o.value=e.response?.data?.error||e.message,e}finally{a.value=!1}},f=async()=>{a.value=!0,o.value=null;try{await u.logout()}catch(s){console.warn("Logout warning:",s.message)}finally{c(),a.value=!1}},k=async(s,r)=>{const e={id:s.user?.id,username:s.user?.username||r.username,email:s.user?.email||r.email,token:s.access_token,role:s.user?.role||"user"};t.login(e),localStorage.setItem("user",JSON.stringify(e))},c=()=>{t.logout(),localStorage.removeItem("user")};return{loading:a,error:o,register:m,login:g,logout:f,checkAuth:()=>{const s=localStorage.getItem("access_token"),r=localStorage.getItem("user");if(s&&r)try{const e=JSON.parse(r);return t.login(e),!0}catch(e){console.error("Failed to restore user session:",e),c()}return!1},isAuthenticated:()=>!!t.token,isAdmin:()=>t.isAdmin,getCurrentUser:()=>({id:t.id,username:t.username,email:t.email,role:t.role,lastLogin:t.formattedLastLogin})}};export{_ as u};
